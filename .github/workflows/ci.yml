name: CI/CD Pipeline with Static Code Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean compile

      - name: Run tests with Surefire
        run: mvn surefire:test

      - name: Generate test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Maven Tests
          path: |
            target/surefire-reports/junitreports/*.xml
            target/surefire-reports/TEST-*.xml
          reporter: java-junit
          fail-on-empty: false

  checkstyle:
    name: Checkstyle Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run Checkstyle
        run: mvn checkstyle:check

      - name: Upload Checkstyle report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: target/checkstyle-result.xml
          if-no-files-found: ignore

  jacoco:
    name: Code Coverage with JaCoCo
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run tests with JaCoCo
        run: mvn clean test jacoco:report

      - name: Upload JaCoCo coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage
          path: target/site/jacoco/
          if-no-files-found: ignore

      - name: Check coverage threshold
        run: mvn jacoco:check

  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    # Enable this job by setting GitHub secrets: SONAR_TOKEN, SONAR_HOST_URL, SONAR_ORGANIZATION, SONAR_PROJECT_KEY
    # See SONARQUBE_SETUP.md for detailed instructions
    # Note: Job will run but fail gracefully if secrets are not set
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Build and analyze with SonarQube
        id: sonar-analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          if [ -z "$SONAR_TOKEN" ]; then
            echo "SonarQube analysis skipped - SONAR_TOKEN secret not configured"
            echo "See SONARQUBE_SETUP.md for setup instructions"
            exit 0
          fi
          if [ -z "$SONAR_ORGANIZATION" ]; then
            echo "Error: SONAR_ORGANIZATION secret is required for SonarQube analysis"
            exit 1
          fi
          mvn clean verify sonar:sonar -Dskip.owasp=true -Dsonar.projectKey=${SONAR_PROJECT_KEY} -Dsonar.pullrequest.github.repository=${{ github.repository }}

      - name: SonarQube Quality Gate Check
        if: steps.sonar-analysis.outcome == 'success'
        uses: sonarsource/sonarqube-quality-gate-action@master
        with:
          scanMetadataReportFile: target/sonar/report-task.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        continue-on-error: false

  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Cache OWASP Dependency-Check database
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository/org/owasp/dependency-check-data
          key: owasp-dependency-check-data-${{ runner.os }}
          restore-keys: |
            owasp-dependency-check-data-${{ runner.os }}

      - name: Run OWASP Dependency-Check
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
          OSSINDEX_USERNAME: ${{ secrets.OSSINDEX_USERNAME }}
          OSSINDEX_TOKEN: ${{ secrets.OSSINDEX_TOKEN }}
        run: mvn org.owasp:dependency-check-maven:check

      - name: Upload dependency check report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: target/dependency-check-report.html
          if-no-files-found: ignore

  quality-gate:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [ build-and-test, checkstyle, jacoco, dependency-check, sonarqube ]
    if: always()
    
    steps:
      - name: Quality Gate Summary
        run: |
          echo "## Static Code Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build and Test: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### Checkstyle: ${{ needs.checkstyle.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### JaCoCo Coverage: ${{ needs.jacoco.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### SonarQube: ${{ needs.sonarqube.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### OWASP Dependency Check: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job logs for detailed reports." >> $GITHUB_STEP_SUMMARY

      - name: Post Quality Gate Summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const summary = `## ğŸ“Š Quality Gate Summary
            
            | Check | Status |
            |-------|--------|
            | Build and Test | ${{ needs.build-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | Checkstyle | ${{ needs.checkstyle.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | JaCoCo Coverage | ${{ needs.jacoco.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | SonarQube | ${{ needs.sonarqube.result == 'success' && 'âœ… Passed' || needs.sonarqube.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |
            | OWASP Dependency Check | ${{ needs.dependency-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            
            **Overall Status:** ${{ (needs.build-and-test.result == 'success' && needs.checkstyle.result == 'success' && needs.jacoco.result == 'success' && needs.dependency-check.result == 'success' && (needs.sonarqube.result == 'success' || needs.sonarqube.result == 'skipped')) && 'âœ… All checks passed!' || 'âŒ Some checks failed' }}
            
            [View detailed reports in Actions artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

